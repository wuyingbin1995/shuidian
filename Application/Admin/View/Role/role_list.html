<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>角色管理</title>
    <link href="__PUBLIC__/Admin/css/bootstrap.min.css" rel="stylesheet">
    <link href="__PUBLIC__/Admin/css/nifty.min.css" rel="stylesheet">
    <link href="__PUBLIC__/Admin/css/nifty-demo-icons.min.css" rel="stylesheet">
    <link href="__PUBLIC__/Admin/css/footable.core.css" rel="stylesheet">
    <script src="__PUBLIC__/Admin/js/jquery-2.2.4.min.js"></script>
    <script src="__PUBLIC__/Admin/js/bootstrap.min.js"></script>
    <script src="__PUBLIC__/Admin/js/nifty.min.js"></script>
    <script src="__PUBLIC__/Admin/js/footable.all.min.js"></script>
    <script src="__PUBLIC__/Admin/js/tables-footable.js"></script>
    <style>
        hr{margin-top: 0;}
        #content-container{padding-top: 0;}
                .hwh-page-info a{color: #CCC;}.hwh-page-info a em{font-style: normal;margin: 0 2px;}
        .pages a,  
            .pages span {  
                display: inline-block;  
                padding: 2px 5px;  
                margin: 0 1px;  
                border: 1px solid #f0f0f0;  
                -webkit-border-radius: 3px;  
                -moz-border-radius: 3px;  
                border-radius: 3px;  
            }  
              
            .pages a,  
            .pages li {  
                display: inline-block;  
                list-style: none;  
                text-decoration: none;  
                color: #58A0D3;  
            }  
              
            .pages a.first,  
            .pages a.prev,  
            .pages a.next,  
            .pages a.end {  
                margin: 0;  
            }  
              
            .pages a:hover {  
                border-color: #50A8E6;  
            }  
              
            .pages span.current {  
                background: #50A8E6;  
                color: #FFF;  
                font-weight: 700;  
                border-color: #50A8E6;  
            }  
    </style>
</head>
<body>


<div id="content-container">
    <div id="page-content">
        <div class="panel">
            <div class="panel-heading">
                <h3 class="panel-title">角色管理</h3>
            </div>
            <div class="panel-body">
                <table id="demo-foo-addrow" class="table table-bordered table-hover toggle-circle" data-page-size="15">
                    <thead>
                    <tr>
                        <th data-sort-initial="true" data-toggle="true" class="text-center">用户编号</th>
                        <th class="text-center">用户昵称</th>
                        <th data-hide="phone, tablet" class="text-center">拥有权限</th>
                        <th data-hide="phone, tablet" class="text-center">拥有方法</th>
                        <th data-sort-ignore="true" class="text-center">操作</th>
                    </tr>
                    </thead>
                    <div class="pad-btm form-inline">
                        <div class="row">
                            <div class="col-sm-6 text-xs-center">
                                <div class="form-group">
                                    <button class="btn btn-purple" data-toggle="modal" data-target=".bs-example-modal-lg">
                                        <i class="demo-pli-plus"></i> 增加角色
                                    </button>
                                </div>
                            </div>
                            <div class="col-sm-6 text-xs-center text-right">
                                <div class="form-group">
                                    <input id="demo-input-search2" type="text" placeholder="关键字查询" class="form-control" autocomplete="off">
                                </div>
                            </div>
                        </div>
                    </div>
                    <tbody class="text-center tbodyTr">
                    <!--循环-->

                    <volist name="auth" key='k' id="vol">
                        <tr>
                            <td>{$vol.role_id}</td>
                            <td>{$vol.role_name}</td>
                            <td>{$vol.role_auth_idname}</td>
                            <td>{$vol.role_auth_ac}</td>
                            <td>
                                <button class="demo-modify-row btn btn-success btn-xs" data-toggle="modal" data-target="#myModal">分配权限</button>
                                <!-- <button class="demo-modify-row btn btn-warning btn-xs">操作记录</button> -->
                                <button class="demo-delete-row btn btn-danger btn-xs">删除用户</button>
                            </td>
                        </tr>
                    </volist>
                    <!--循环-->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="7">
                                <div class="text-right" align="right">
                                    {$page}
                                </div>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>
<!--增加用户信息模块-->
<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">请填写你要增加的用户信息:</h4>
            </div>
            <div class="modal-body">
                <div class="form-horizontal">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label text-right">角色名称</label>
                                <div class="col-md-8">
                                    <input class="form-control" type="text" id="AddTrIndexUserTd0">
                                </div>
                            </div>
                        </div>
<!--                         <div class="col-md-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label text-right">用户昵称</label>
                                <div class="col-md-8">
                                    <input class="form-control" type="text" id="AddTrIndexUserTd1">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label text-right">密码</label>
                                <div class="col-md-8">
                                    <input class="form-control" type="text" id="AddTrIndexUserTd2">
                                </div>
                            </div>
                        </div> -->
                    </div><br><br>
                    <div class="row">
                        <!-- <div class="col-md-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label text-right">角色</label>
                                <div class="col-md-8">
                                    <select class="form-control" id="AddTrIndexUserTd5">
                                        <option value="一号权限">一号权限</option>
                                        <option value="二号权限">二号权限</option>
                                        <option value="三号权限">三号权限</option>
                                        <option value="四号权限">四号权限</option>
                                        <option value="五号权限">五号权限</option>
                                        <option value="六号权限">六号权限</option>
                                    </select>
                                </div>
                            </div>
                        </div> -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary demo-btn-addrow" data-dismiss="modal">提交</button>
            </div>
        </div>
    </div>
</div>

<!--分配权限模块-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel"></h4>
            </div>
            <div class="modal-body">
            <!-- 一级权限循环 -->
            <volist name="top" id="top_v" >
                <div class="form-horizontal">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-checkbox form-normal form-primary form-text ">
                                <input type="checkbox"  class="InputZi" value="{$top_v.id}" disabled name="InputFU{$top_v.id}" >
                                {$top_v.auth_name}
                            </label>
                        </div>
                    </div>
                    <div class="row">
                    <!-- 二级权限循环 -->
                    <volist name="second" key="k" id="second_v">
                    <if condition="$top_v.id == $second_v.pid ">
                        <div class="col-md-offset-1 col-md-3">
                            <label  class="form-checkbox form-normal form-primary form-text " >
                                <input  type="checkbox" class="InputZi InputFU{$top_v.id}" disabled  value="{$second_v.id}" name="" >{$second_v.auth_name}
                            </label>
                        </div>
                        </if>
                    </volist>
                    <!-- 二级循环完毕 -->
                    </div><br>
                </div>
            </volist>
            <!-- 一级权限循环完毕 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="myModalSuccess">提交</button>
            </div>
        </div>
    </div>
</div>

</body>
<script>
    $(function(){

        /*新建用户信息*/
        var addrow = $('#demo-foo-addrow');
        $('.demo-btn-addrow').click(function(){
            var AddTrIndexUserTd0 = $("#AddTrIndexUserTd0").val();
            var data = {'role_name': AddTrIndexUserTd0};
            // console.log(data);return;
            $.ajax({
                'url'   : '__CONTROLLER__/role_add',
                'type'  : 'post',
                'data'  : data ,
                'dataType' : 'json',
                'success' : function(response){
                    if(response.code != 10000){
                        //添加失败
                        alert(response.msg);
                        return;
                    }else{
                        //添加成功
                        //console.log(response.role_auth_ids);
                        //return;
                        window.location.reload();
                    }
                }
            });
        });
       var   ejqx=$('#ejqx').html();
        //分配权限；
        $(".demo-modify-row").click(function(){

            /*弹出框*/
            $('#myInput').focus();
            /*获取到你点击那一行的下标*/
            var TrIndex = $(this).parent().parent().index();
            /*获取到你点击的那一行里面的内容*/
            var TrIndexUser = $(".tbodyTr tr:eq("+TrIndex+") td:eq(0)").text();
            $("#myModalLabel").html("正在操作的用户编号为 : "+TrIndexUser);
            /*现在拥有的权限*/
            var TrIndexUserTd5 = $(".tbodyTr tr:eq("+TrIndex+") td:eq(5) span").text();
            //alert(TrIndexUser);
            var data = {'id' : TrIndexUser};
       
            
            $.ajax({
                'url'   : '__CONTROLLER__/role_list',
                'type'  : 'post',
                'data'  : data ,
                'dataType' : 'json',
                'success' : function(response)
                {
                    //console.log(JSON.stringify(response))
                    if(response.code != 10000)
                    {
                        //获取失败
                        alert(response.msg);
                        return;
                    }else
                    {
                        // 获取成功
                      
                        var role_auth_ids=response['role_auth_ids'];        //获取返回的当前点击的对象的拥有ID
                        for(var i=0;i<$('.InputZi').length;i++)             //循环所有 类名为InputZi的数据
                        {
                            $('.InputZi').eq(i).removeAttr('checked');      //移除所有权限的选中状态
                            $('.InputZi').eq(i).parent().attr('class','form-checkbox form-normal form-primary form-text');   //给所有权限添加可选中状态
                            for(var a=0;a<role_auth_ids.length;a++)         //循环拥有的权限
                            {
                                var  aa=$('.InputZi').eq(i).attr('name');           //获取当前权限的名字
                                if( $('.InputZi').eq(i).val()==role_auth_ids[a])    //判断当前权限的ID是否等于 拥有的权限
                                {                                                   //等于的话下移
                                    $('.InputZi').eq(i).removeAttr("disabled");     //移除当前权限的不可修改状态
                                    $('.InputZi').eq(i).prop('checked','checked');  //给当前权限添加选中状态

                                    $('.InputZi').eq(i).parent().attr('class','form-checkbox form-normal form-primary form-text active');   //给当前权限的一级权限添加可选中状态
                                    if(aa!='')                                      //当前权限的名称不为空的话
                                    {
                                        $('input[name='+aa+']').removeAttr("disabled"); //移除当前权限的不可修改状态
                                        for(var c=0;c<$('.'+aa).length;c++)         //循环当前权限的长度
                                        {
                                            $('.'+aa).eq(c).removeAttr("disabled"); //给当前权限移除不可修改状态
                                        }
                                    }
                                }else                                               //当前权限的ID不等于拥有的权限的话
                                {
                                    if(aa!='')                                      //当前权限的名称不为空的话
                                    {
                                        $('.InputZi').eq(i).removeAttr("disabled");    //移除当前权限的不可修改状态
                                    }
                                }
                            }
                        }
                    }
                }
            });

            /*权限分配*/
            $(".form-checkbox").click(function()
            {
                var class_name= $(this).children(0).attr('name');       //获取input name值   用来执行下面的判断
                if(class_name!='')                                      //input name值  的是否为空  为空则表示当前是二级权限   否则一级
                {
                    var InputFu = $(this).children(0).prop("checked");  //获取二级权限的checked属性
                    if(InputFu)                                         //如果有checked的话
                    {
                        $("."+class_name).removeAttr('disabled');       //有的话移除二级权限的disabled  
                    }else
                    {
                        $("."+class_name).removeAttr('checked');        //没有的话移除checked属性
                        for(var i=0;i<$("."+class_name).length;i++)     //循环二级权限
                        {
                            $("."+class_name).eq(i).parent().attr('class','form-checkbox form-normal form-primary form-text');  //给父级设置没有选中状态
                        }
                        $("."+class_name).prop("disabled",'disabled');  //给二级权限设置不可选中状态
                    }
                }
            });

            /*点击提交*/
            $("#myModalSuccess").click(function(){
                //获取勾选中的数据
                var data = [];
                $('input[type=checkbox]:checked').each(function(){ 
                data.push($(this).val()); 
                }); 
                data.push(TrIndexUser);
                data = {
                    'data' : data
                };
                //发送ajax添加请求
                $.ajax({
                    'url'   : '__CONTROLLER__/role_edit',
                    'type'  : 'post',
                    'data'  : data,
                    'dataType' : 'json',
                    'success' : function(response){
                        if(response.code != 10000){
                            //添加失败
                            alert(response.msg);
                            return;
                        }else{
                            //添加成功
                            window.location.reload();
                        }
                    },
                });
            });
        });

        //刪除
        $(".demo-delete-row").click(function(){
            if(confirm('是否删除？'))
            {
                /*获取到你点击那一行的下标*/
                var TrIndex = $(this).parent().parent().index();
                /*获取到你点击的那一行里面的内容*/
                var TrIndexUser = $(".tbodyTr tr:eq("+TrIndex+") td:eq(0)").text();
                //组装要发生的数据
                var data = {'role_id' : TrIndexUser};
                // console.log(data);
                // return;
                //发送ajax请求
                $.ajax({
                    'url':'__CONTROLLER__/role_del',
                    'type':'post',
                    'data':data,
                    'dataType':'json',
                    'success':function(response){
                        //console.log(response);
                        if(response.code != 10000){
                            //判断返回结果中的code ，不是10000都代表失败，提示错误信息
                            alert(response.msg);
                            return;
                        }else{
                            //删除成功刷新当前页面，同步数据库数据
                            window.location.reload();
                        }
                    }
                });
            }    
        });
    });
</script>
</html>